
https://app.globus.org/file-manager?origin_id=1ef9019c-eac0-11ed-9ba9-c9bb788c490e&origin_path=%2F%7E%2F
JSALTdir=/work/k.church/JSALT-2023/
JSALTsrc=/work/k.church/githubs/JSALT_Better_Together/src

specter=$JSALTdir/semantic_scholar/embeddings/specter
proposed=$JSALTdir/semantic_scholar/embeddings/proposed

query=232040593

# Find 10 papers near query (using specter embedding)
echo $query | $JSALTsrc/C/near_with_floats --floats $specter/embedding.K768.f --record_size 768 --offset 5 --map $specter/map $specter/idx.???.i > /tmp/near.specter
cut -f1,3 < /tmp/near.specter | sort -nr -u | head

# Same as above, but replace specter embedding with proposed embedding
echo $query | $JSALTsrc/C/near_with_floats --floats $proposed/embedding.K280.f --record_size 280 --offset 5 --map $proposed/map $proposed/idx.??.i > /tmp/near.proposed
cut -f1,3 < /tmp/near.proposed | sort -nr -u | head

# map ids in second col to URLs
cut -f1,3 < /tmp/near.specter | sort -nr -u | head |
$JSALTsrc/C/find_lines --input $JSALTdir/semantic_scholar/papers/corpusId_to_href --fields '-L'

# ditto (same as above)
cut -f1,3 < /tmp/near.proposed | sort -nr -u | head |
$JSALTsrc/C/find_lines --input $JSALTdir/semantic_scholar/papers/corpusId_to_href --fields '-L'


# get references from query
echo $query | 
     $JSALTsrc/fetch_references_and_citations.py |
     egrep '^reference' | 
     cut -f3 | 
     egrep -v ERROR > /tmp/references


cat /tmp/references | $JSALTsrc/C/near_with_floats --floats $specter/embedding.K768.f --record_size 768 --offset 5 --map $specter/map $specter/idx.???.i > /tmp/references.specter
cat /tmp/references | $JSALTsrc/C/near_with_floats --floats $proposed/embedding.K280.f --record_size 280 --offset 5 --map $proposed/map $proposed/idx.??.i > /tmp/references.proposed

cat /tmp/references | $JSALTsrc/C/id_to_floats --record_size 768 --map $specter/map --floats $specter/embedding.K768.f > /tmp/references.vec.specter
cat /tmp/references | $JSALTsrc/C/id_to_floats --record_size 280 --map $proposed/map --floats $proposed/embedding.K280.f > /tmp/references.vec.proposed

# Each line starts with two ids
# followed by K floats
awk '{print NF, FILENAME}' /tmp/references.vec.* | uniq -c
    143 282 /tmp/references.proposed
    143 770 /tmp/references.specter

